<!doctype html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Quizzer</title>
  <style>
    body {
      font-family: sans-serif;
    }

    button.choice {
      color: darkred;
      font-weight: bold;
    }

    h1#pollid {
      font-family: monospace;
    }
  </style>
  <style id="server-style">
  </style>
</head>

<body onload="connect()">
  <h1 id="pollid"> </h1>
  <div id="buttons"></div>
  <script>
    function connect() {
      let base = document.baseURI.replace(/^http(s?):/, "ws$1:").replace(/\/[^\/]*$/, "");
      let quiz = location.hash.slice(1);
      let header = document.querySelector("h1#pollid");
      let buttons = document.querySelector("div#buttons");
      let style = document.querySelector("style#server-style");
      header.textContent = quiz;

      let socket = new WebSocket(`${base}/quiz/${quiz}`);
      socket.addEventListener("message", e => {
        let message = JSON.parse(e.data);
        console.log(message);
        switch (message.tag) {
          case "Idle":
            while (buttons.firstChild) {
              buttons.removeChild(buttons.firstChild);
            }
            break;
          case "Begin":
            let votes = new Set();
            for (let i = 0; i < message.choices.length; i++) {
              let text = message.choices[i];
              let button = document.createElement("button");
              button.setAttribute("id", String.fromCharCode(65 + i));
              button.textContent = text;
              button.addEventListener("click", _ => {
                if (!button.classList.contains("checked")) {
                  votes.add(text);
                  button.classList.add("checked");
                  if (votes.size == message.votes)
                    disableOthers(buttons, button, true);
                } else {
                  if (votes.size == message.votes)
                    disableOthers(buttons, button, false);
                  button.classList.remove("checked");
                  votes.delete(text);
                }
                socket.send(JSON.stringify({ "vote": [...votes] }));
              });
              buttons.appendChild(button);
            }
            break;
          case "End":
            for (let button of buttons.children)
              button.setAttribute("disabled", 1);
            break;
          case "Css":
            style.textContent = message.css;
            break;
        }
      });
    }

    function disableOthers(buttons, button, disable) {
      for (let b of buttons.children)
        if (b.id != button.id)
          if (disable) {
            b.setAttribute("disabled", true);
            console.log("disable", b.id);
          } else {
            b.removeAttribute("disabled");
            console.log("enable", b.id);
          }
    }
  </script>
</body>

</html>